name: CPP Module Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-cpp-modules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential wget
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq
    
    - name: Create test files if missing
      run: |
        # Create test_ex00.yaml if it doesn't exist
        if [ ! -f "cpp00/ex00/test_ex00.yaml" ]; then
          cat > cpp00/ex00/test_ex00.yaml << 'YAML'
        ---
        test_cases:
          - name: "No arguments - should output default message"
            command: "./megaphone"
            expected_output: "* LOUD AND UNBEARABLE FEEDBACK NOISE *"
            exit_code: 1

          - name: "Single lowercase string"
            command: "./megaphone hello"
            expected_output: "HELLO"
            exit_code: 0

          - name: "Single uppercase string"
            command: "./megaphone HELLO"
            expected_output: "HELLO"
            exit_code: 0

          - name: "Mixed case string"
            command: "./megaphone HeLLo WoRLd"
            expected_output: "HELLO WORLD"
            exit_code: 0

          - name: "Multiple arguments"
            command: "./megaphone hello world test"
            expected_output: "HELLO WORLD TEST"
            exit_code: 0

          - name: "String with special characters"
            command: "./megaphone hello123"
            expected_output: "HELLO123"
            exit_code: 0

          - name: "Empty string argument"
            command: "./megaphone ''"
            expected_output: ""
            exit_code: 0

          - name: "Spaces only"
            command: "./megaphone '   '"
            expected_output: "   "
            exit_code: 0

          - name: "Numbers and symbols"
            command: "./megaphone test@123 hello#world"
            expected_output: "TEST@123 HELLO#WORLD"
            exit_code: 0
        YAML
        fi
        
        # Create test_ex01.yaml if it doesn't exist
        if [ ! -f "cpp00/ex01/test_ex01.yaml" ]; then
          cat > cpp00/ex01/test_ex01.yaml << 'YAML'
        ---
        test_scenarios:
          - name: "Invalid command"
            description: "Test that invalid commands produce error message"
            input_sequence:
              - "INVALID"
              - "EXIT"

          - name: "Exit program"
            description: "Test EXIT command terminates program"
            input_sequence:
              - "EXIT"

          - name: "Add a contact"
            description: "Test ADD command to add contact to phonebook"
            input_sequence:
              - "ADD"
              - "John"
              - "Doe"
              - "johnny"
              - "1990-01-01"
              - "0123456789"
              - "EXIT"

          - name: "Add multiple contacts"
            description: "Test adding multiple contacts (up to 8)"
            input_sequence:
              - "ADD"
              - "Alice"
              - "Smith"
              - "alice"
              - "1995-05-15"
              - "0111111111"
              - "ADD"
              - "Bob"
              - "Johnson"
              - "bob"
              - "1992-03-20"
              - "0222222222"
              - "EXIT"

          - name: "Search for contact"
            description: "Test SEARCH command to find a contact"
            input_sequence:
              - "ADD"
              - "Charlie"
              - "Brown"
              - "charlie"
              - "1998-07-10"
              - "0333333333"
              - "SEARCH"
              - "0"
              - "EXIT"

          - name: "Display menu"
            description: "Test that menu is displayed at startup"
            input_sequence:
              - "EXIT"
        YAML
        fi
    
    - name: Discover and test all exercises
      run: |
        #!/bin/bash
        set -e
        
        total_passed=0
        total_failed=0
        
        # Find all exercises with test YAML files
        echo "Searching for exercises..."
        exercises=$(find . -name "test_*.yaml" | sort)
        
        if [ -z "$exercises" ]; then
          echo "No test files found!"
          exit 1
        fi
        
        echo "Found exercises to test:"
        echo "$exercises"
        echo "=========================================="
        
        for test_file in $exercises; do
          ex_dir=$(dirname "$test_file")
          test_name=$(basename "$test_file")
          
          echo ""
          echo "=========================================="
          echo "Testing: $ex_dir"
          echo "Test file: $test_name"
          echo "=========================================="
          
          # Check if Makefile exists
          if [ ! -f "$ex_dir/Makefile" ]; then
            echo "No Makefile found in $ex_dir, skipping..."
            continue
          fi
          
          # Build
          echo "Building..."
          cd "$ex_dir"
          if ! make > /dev/null 2>&1; then
            echo "✗ Build failed for $ex_dir"
            ((total_failed++))
            cd - > /dev/null
            continue
          fi
          echo "Build successful!"
          echo "------------------------------------------"
          
          # Check test type and run tests
          if yq e '.test_cases' "$test_name" > /dev/null 2>&1; then
            # Simple command-line tests (ex00)
            test_count=$(yq e '.test_cases | length' "$test_name")
            passed=0
            failed=0
            
            for ((i=0; i<test_count; i++)); do
              test_num=$((i+1))
              name=$(yq e ".test_cases[$i].name" "$test_name")
              command=$(yq e ".test_cases[$i].command" "$test_name")
              expected=$(yq e ".test_cases[$i].expected_output" "$test_name")
              expected_exit=$(yq e ".test_cases[$i].exit_code // 0" "$test_name")
              
              # Run command
              output=$(eval "$command" 2>&1 || true)
              exit_code=$?
              
              # Compare results
              if [ "$output" = "$expected" ] && [ "$exit_code" = "$expected_exit" ]; then
                echo "✓ Test $test_num passed: $name"
                ((passed++))
              else
                echo "✗ Test $test_num failed: $name"
                echo "  Expected: '$expected'"
                echo "  Got: '$output'"
                echo "  Expected exit: $expected_exit, Got: $exit_code"
                ((failed++))
              fi
            done
            
            echo "------------------------------------------"
            echo "Results: $passed passed, $failed failed"
            total_passed=$((total_passed + passed))
            total_failed=$((total_failed + failed))
            
          elif yq e '.test_scenarios' "$test_name" > /dev/null 2>&1; then
            # Interactive tests (ex01)
            test_count=$(yq e '.test_scenarios | length' "$test_name")
            passed=0
            failed=0
            
            # Find executable
            executable=$(find . -maxdepth 1 -type f -executable ! -name "*.sh" | head -1)
            if [ -z "$executable" ]; then
              echo "✗ No executable found"
              ((total_failed++))
              cd - > /dev/null
              continue
            fi
            
            for ((i=0; i<test_count; i++)); do
              test_num=$((i+1))
              name=$(yq e ".test_scenarios[$i].name" "$test_name")
              description=$(yq e ".test_scenarios[$i].description" "$test_name")
              
              echo "Test $test_num: $name"
              echo "  Description: $description"
              
              # Get input sequence
              input_count=$(yq e ".test_scenarios[$i].input_sequence | length" "$test_name")
              input_data=""
              for ((j=0; j<input_count; j++)); do
                line=$(yq e ".test_scenarios[$i].input_sequence[$j]" "$test_name")
                input_data="${input_data}${line}"$'\n'
              done
              
              # Run with timeout
              if timeout 5s bash -c "echo '$input_data' | $executable" > /dev/null 2>&1; then
                echo "✓ Test $test_num passed: $name"
                ((passed++))
              else
                exit_code=$?
                if [ $exit_code -eq 124 ]; then
                  echo "✗ Test $test_num failed: $name (timeout)"
                else
                  echo "✗ Test $test_num failed: $name (exit code: $exit_code)"
                fi
                ((failed++))
              fi
            done
            
            echo "------------------------------------------"
            echo "Results: $passed passed, $failed failed"
            total_passed=$((total_passed + passed))
            total_failed=$((total_failed + failed))
          fi
          
          # Cleanup
          make fclean > /dev/null 2>&1 || true
          cd - > /dev/null
        done
        
        echo ""
        echo "=========================================="
        echo "OVERALL RESULTS: $total_passed passed, $total_failed failed"
        echo "=========================================="
        
        if [ $total_failed -gt 0 ]; then
          exit 1
        fi
